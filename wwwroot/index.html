<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <title>TO-DO</title>
  </head>
  <header>
    <h1>TO-DO DASHBOARD</h1>
    <div id="relogio">00:00:00</div>
  </header>
  <body>
    <div class="div_input">
      <input
        id="input_id"
        type="text"
        placeholder="Digite o nome da tarefa..."
      />
      <button onclick="adicionar()">Adicionar Tarefa</button>
    </div>
    <main>
      <section>
        <h3>A Fazer</h3>
        <ul
          class="ul_1"
          id="lista1"
          ondrop="drop(event)"
          ondragover="allowDrop(event)"
          ondragleave="removeHighlight(event)"
        ></ul>
      </section>
      <section>
        <h3>Em andamento</h3>
        <ul
          class="ul_emAndamento"
          id="lista2"
          ondrop="drop(event)"
          ondragover="allowDrop(event)"
          ondragleave="removeHighlight(event)"
        ></ul>
      </section>

      <section>
        <h3>Concluído</h3>
        <ul
          class="ul_concluido"
          id="lista3"
          ondrop="drop(event)"
          ondragover="allowDrop(event)"
          ondragleave="removeHighlight(event)"
        ></ul>
      </section>
    </main>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", listar);

    function allowDrop(ev) {
      ev.preventDefault();
      ev.currentTarget.classList.add("drag-over");
    }

    function removeHighlight(ev) {
      ev.currentTarget.classList.remove("drag-over");
    }

    function drag(ev) {
      ev.dataTransfer.setData("idItem", ev.target.id);
    }

    async function drop(ev) {
      ev.preventDefault();
      ev.currentTarget.classList.remove("drag-over");

      const id = ev.dataTransfer.getData("idItem");
      const itemArrastado = document.getElementById(id);

      // Acha a lista UL de destino (evita erro se soltar em cima de outro LI)
      const listaDestino = ev.target.closest("ul");
      if (!listaDestino) return;

      listaDestino.appendChild(itemArrastado);

      // Identifica o status baseado na lista de destino
      const ehConcluido = listaDestino.classList.contains("ul_concluido");
      const ehEmAndamento = listaDestino.classList.contains("ul_emAndamento");

      const tarefaId = id.replace("tarefa-", "");
      const tarefaTitulo = itemArrastado.querySelector("span").innerText;

      // Enviamos o estado direto, sem precisar calcular "proximo"
      await salvarAlteracaoStatus(
        tarefaId,
        tarefaTitulo,
        ehConcluido,
        ehEmAndamento,
      );
      listar();
    }

    async function listar() {
      const res = await fetch("http://localhost:5137/tarefas");
      const dados = await res.json();

      const listas = {
        pendente: document.querySelector(".ul_1"),
        andamento: document.querySelector(".ul_emAndamento"),
        concluida: document.querySelector(".ul_concluido"),
      };

      // Limpa todas as listas
      Object.values(listas).forEach((l) => (l.innerHTML = ""));

      dados.forEach((tarefa) => {
        const cor = tarefa.concluida
          ? "green"
          : tarefa.emAndamento
            ? "yellow"
            : "red";

        const html = `
            <li id="tarefa-${tarefa.id}" class="li_style" style="background-color: ${cor};" draggable="true" ondragstart="drag(event)">
                <span>${tarefa.titulo}</span>
                <button onclick="deletar(${tarefa.id})">❌</button>
            </li>`;

        if (tarefa.concluida) listas.concluida.innerHTML += html;
        else if (tarefa.emAndamento) listas.andamento.innerHTML += html;
        else listas.pendente.innerHTML += html;
      });
    }

    // Mudei o nome para salvarAlteracaoStatus para ficar mais claro
    async function salvarAlteracaoStatus(id, titulo, concluida, emAndamento) {
      const payload = {
        Id: parseInt(id),
        Titulo: titulo,
        Concluida: concluida,
        EmAndamento: emAndamento,
      };

      await fetch(`http://localhost:5137/tarefas/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    }

    async function adicionar() {
      const input = document.getElementById("input_id");
      if (!input.value.trim()) return alert("Digite algo.");

      const res = await fetch("http://localhost:5137/tarefas", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ titulo: input.value }),
      });

      if (res.ok) {
        input.value = "";
        listar();
      }
    }

    async function deletar(id) {
      if (!confirm("Excluir tarefa?")) return;
      const res = await fetch(`http://localhost:5137/tarefas/${id}`, {
        method: "DELETE",
      });
      if (res.ok) listar();
    }
  </script>
</html>
